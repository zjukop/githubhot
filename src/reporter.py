"""Report generator for markdown daily reports."""

from datetime import datetime, timezone
from pathlib import Path

from loguru import logger

from .ai_summarizer import SummaryResult
from .config import get_settings
from .crawler import CrawlerResult


class ReportGenerator:
    """Generate markdown daily reports."""

    def __init__(self):
        self.settings = get_settings()
        self.reports_dir = Path(self.settings.reports_dir)
        self.reports_dir.mkdir(parents=True, exist_ok=True)

    def generate(
        self, crawler_result: CrawlerResult, summary_result: SummaryResult
    ) -> Path:
        """
        Generate a markdown report and save to file.

        Returns:
            Path to the generated report file.
        """
        today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
        filename = self.reports_dir / f"{today}.md"

        content = self._build_report(crawler_result, summary_result, today)

        filename.write_text(content, encoding="utf-8")
        logger.success(f"Report generated: {filename}")

        return filename

    def _build_report(
        self, crawler_result: CrawlerResult, summary_result: SummaryResult, date: str
    ) -> str:
        """Build the markdown report content."""
        lines = [
            f"# GitHub Daily Trends - {date}",
            "",
            f"> æ•°æ®æ¥æº: {crawler_result.source} | æ›´æ–°æ—¶é—´: {crawler_result.crawled_at.strftime('%Y-%m-%d %H:%M UTC')}",
            "",
        ]

        # Table of Contents
        lines.extend(
            [
                "## ðŸ“‘ ç›®å½•",
                "",
                "- [ðŸ† ä»Šæ—¥ç²¾é€‰](#-ä»Šæ—¥ç²¾é€‰)",
                "- [ðŸ‘€ å¿«é€Ÿæµè§ˆ](#-å¿«é€Ÿæµè§ˆ)",
                "- [ðŸ“Š ç»Ÿè®¡ä¿¡æ¯](#-ç»Ÿè®¡ä¿¡æ¯)",
                "",
            ]
        )

        # Top Picks Section
        lines.extend(
            [
                "## ðŸ† ä»Šæ—¥ç²¾é€‰",
                "",
                "ä»¥ä¸‹æ˜¯ä»Šæ—¥æœ€å€¼å¾—å…³æ³¨çš„é¡¹ç›®ï¼š",
                "",
            ]
        )

        if summary_result.top_picks:
            for summary in summary_result.top_picks:
                lines.append(summary.to_markdown())
        else:
            lines.append("*ä»Šæ—¥æš‚æ— ç²¾é€‰é¡¹ç›®*\n")

        # Quick Looks Section
        lines.extend(
            [
                "## ðŸ‘€ å¿«é€Ÿæµè§ˆ",
                "",
                "å…¶ä»–å€¼å¾—äº†è§£çš„é¡¹ç›®ï¼š",
                "",
            ]
        )

        if summary_result.quick_looks:
            for summary in summary_result.quick_looks:
                lines.append(summary.to_markdown())
        else:
            lines.append("*æš‚æ— å…¶ä»–é¡¹ç›®*\n")

        # Statistics Section
        all_summaries = summary_result.all_summaries
        if all_summaries:
            languages = {}
            total_stars = 0
            for s in all_summaries:
                lang = s.repo.language or "Unknown"
                languages[lang] = languages.get(lang, 0) + 1
                total_stars += s.repo.stars

            top_languages = sorted(languages.items(), key=lambda x: x[1], reverse=True)[:5]

            lines.extend(
                [
                    "## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯",
                    "",
                    f"- **æ”¶å½•é¡¹ç›®æ•°**: {len(all_summaries)}",
                    f"- **ç²¾é€‰é¡¹ç›®æ•°**: {len(summary_result.top_picks)}",
                    f"- **æ€» Star æ•°**: {total_stars:,}",
                    f"- **è¯­è¨€åˆ†å¸ƒ**: {', '.join(f'{k}({v})' for k, v in top_languages)}",
                    "",
                ]
            )

        # Footer
        lines.extend(
            [
                "---",
                "",
                "*Generated by [GitHub-Daily-Trends-AI](https://github.com/your-repo) ðŸ¤–*",
            ]
        )

        return "\n".join(lines)


def generate_report(
    crawler_result: CrawlerResult, summary_result: SummaryResult
) -> Path:
    """Convenience function to generate report."""
    generator = ReportGenerator()
    return generator.generate(crawler_result, summary_result)
